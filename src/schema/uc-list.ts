import { asis } from '@proc7ts/primitives';
import { UcdTypeDef } from '../compiler/deserialization/ucd-type-def.js';
import { UccCode } from '../compiler/ucc-code.js';
import { UcPrimitive } from './uc-primitive.js';
import { ucSchemaName } from './uc-schema-name.js';
import { UcSchema, UcSchema__symbol } from './uc-schema.js';
import { UcValue } from './uc-value.js';

/**
 * URI charge list represented as JavaScript array.
 *
 * @typeParam TValue - List item value type.
 */
export type UcList<TValue = UcPrimitive> = UcValue<TValue>[];

export namespace UcList {
  /**
   * URI charge schema definition for JavaScript {@link UcList array} serialized as list.
   *
   * Such schema can be built with {@link ucList} function.
   *
   * @typeParam TItemSpec - Type of list item schema specifier.
   */
  export interface Schema<
    TItem = unknown,
    TItemSpec extends UcSchema.Spec<TItem> = UcSchema.Spec<TItem>,
  > extends UcSchema<TItem[]> {
    readonly type: 'list';
    readonly isList: true;

    /**
     * List item schema.
     */
    readonly item: UcSchema.Of<TItemSpec>;

    /**
     * Generates list deserialization code.
     *
     * {@link @hatsy/churi/compiler!UcdListDef List deserializer definition} is used by default.
     *
     * @param schema - Schema of deserialized value.
     * @param location - A location inside deserializer function to insert generated code into.
     *
     * @returns Deserializer code source, or `undefined` to generate one automatically.
     */
    deserialize?(
      this: void,
      schema: Schema<TItem, TItemSpec>,
      location: UcdTypeDef.Location,
    ): UccCode.Source | undefined;
  }

  export namespace Schema {
    /**
     * Schema specifier of URI charge list.
     *
     * @typeParam TItemSpec - Type of list item schema specifier.
     */
    export type Spec<TItem, TItemSpec extends UcSchema.Spec<TItem> = UcSchema.Spec<TItem>> =
      | Schema<TItem, TItemSpec>
      | Ref<TItem, TItemSpec>;

    /**
     * Reference to schema of URI charge list.
     *
     * @typeParam TItemSpec - Type of list item schema specifier.
     */
    export type Ref<
      TItem,
      TItemSpec extends UcSchema.Spec<TItem> = UcSchema.Spec<TItem>,
    > = UcSchema.Ref<TItem[], Schema<TItem, TItemSpec>>;

    /**
     * Additional options for URI charge list schema.
     */
    export interface Options<TItem, TItemSpec extends UcSchema.Spec<TItem>> {
      /**
       * Unique schema identifier.
       *
       * @defaultValue Autogenerated string.
       */
      readonly id?: string | UcSchema.Class | undefined;

      /**
       * Generates list deserialization code.
       *
       * {@link @hatsy/churi/compiler!UcdListDef List deserializer definition} is used by default.
       *
       * @param schema - Schema of deserialized value.
       * @param location - A location inside deserializer function to insert generated code into.
       *
       * @returns Deserializer code source, or `undefined` to generate one automatically.
       */
      deserialize?(
        this: void,
        schema: Schema<TItem, TItemSpec>,
        location: UcdTypeDef.Location,
      ): UccCode.Source | undefined;
    }
  }
}

/**
 * Creates a reference to URI charge schema for JavaScript {@link UcList array} serialized as list.
 *
 * @typeParam TItemSpec - Type of list item schema specifier.
 * @param itemSpec - List item schema specifier.
 *
 * @returns Reference to schema of URI charge list.
 */
export function ucList<TItem, TItemSpec extends UcSchema.Spec<TItem> = UcSchema.Spec<TItem>>(
  itemSpec: TItemSpec,
  options?: UcList.Schema.Options<TItem, TItemSpec>,
): UcList.Schema.Ref<TItem, TItemSpec>;

export function ucList<TItem, TItemSpec extends UcSchema.Spec<TItem> = UcSchema.Spec<TItem>>(
  itemSpec: TItemSpec,
  { id }: UcList.Schema.Options<TItem, TItemSpec> = {},
): UcList.Schema.Ref<TItem, TItemSpec> {
  return {
    [UcSchema__symbol]: resolver => {
      const item = resolver.schemaOf(itemSpec) as UcSchema.Of<TItemSpec>;

      return {
        type: 'list',
        id: id ?? `list_${++UcList$idSeq}`,
        isList: true,
        item,
        asis,
        toString() {
          return `${ucSchemaName(item)}[]`;
        },
      };
    },
  };
}

let UcList$idSeq = 0;
